"use client";
import React, { useEffect, useState } from "react";
import Select from "./Statistics/Select";
import { useGetAdminStatsQuery } from "@/app/_fetures/lib/api/publicLobbiesApi";
import { GetAdminStatsRequest } from "@/app/_utils/types";
import { useHandleError } from "@/app/_utils/hooks/useTemplatedError";
import { Information } from "../Loading/Loading";
import { formatNumberWithSpaces } from "@/app/_utils/functions";

const Day = "За сегодня";
const Month = "За месяц";
const Week = "За неделю";
const All = "За всё время";
const AllCounts = "Все";
const isOnline = "Онлайн";
const MatchEnded = "Завершены";
const MatchPlaying = "Идут";
const MatchCanceled = "Не состоялись";
const AllServers = "Все";
const WorkServers = "Работают";
const NotWorkingServers = "Не работают";
const usersSelectors = [AllCounts, isOnline, Day, Week, Month];
const matchesSelectors = [MatchEnded, MatchPlaying, MatchCanceled];
const serversSelectors = [AllServers, WorkServers, NotWorkingServers];
const comissionsSelectors = [Day, Week, Month, All];
const financialSelectors = [Day, Week, Month, All];
const MatchStatusToProp = {
  [MatchEnded]: "MatchEnded",
  [MatchPlaying]: "MatchPlaying",
  [MatchCanceled]: "MatchCanceled",
};
const IntervalToProp = {
  [All]: "All",
  [Day]: "Day",
  [Week]: "Week",
  [Month]: "Month",
};
const defaultStatsRequest: GetAdminStatsRequest = {
  financialRotationInterval: IntervalToProp[All],
  isOnlineUsers: null,
  lobbyComissionsInterval: IntervalToProp[All],
  matchesStatus: MatchStatusToProp[MatchPlaying],
  onlyHealthyServers: null,
  userInterval: IntervalToProp[All],
};

export const AdminStats = () => {
  const [users, setUsers] = useState(AllCounts);
  const [financialRotation, setFinancialRotation] = useState(All);
  const [comission, setComission] = useState(All);
  const [servers, setServers] = useState(AllServers);
  const [matches, setMatches] = useState(MatchEnded);

  const [statReq, setStatReq] =
    useState<GetAdminStatsRequest>(defaultStatsRequest);
  useEffect(() => {
    setStatReq({
      financialRotationInterval: IntervalToProp[financialRotation],
      isOnlineUsers: users === isOnline ? true : null,
      lobbyComissionsInterval: IntervalToProp[comission],
      matchesStatus: MatchStatusToProp[matches],
      onlyHealthyServers:
        servers === AllServers ? null : servers === WorkServers,
      userInterval: users === isOnline ? null : IntervalToProp[users],
    });
  }, [users, financialRotation, comission, servers, matches]);
  const { data: stats, isLoading, error } = useGetAdminStatsQuery(statReq);
  const commonErrorText = useHandleError(error);
  if ((isLoading && !stats) || commonErrorText)
    return (
      <Information
        loading={isLoading && !stats}
        errorMessage={commonErrorText}
      ></Information>
    );
  return (
    <>
      <div className="relative flex items-center px-8 py-6 rounded-lg shadow bg-saturateBlue/10 gap-6">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="65"
          height="52"
          viewBox="0 0 65 52"
          fill="none"
        >
          <path
            d="M9.75 22.75C13.3352 22.75 16.25 19.8352 16.25 16.25C16.25 12.6648 13.3352 9.75 9.75 9.75C6.16484 9.75 3.25 12.6648 3.25 16.25C3.25 19.8352 6.16484 22.75 9.75 22.75ZM55.25 22.75C58.8352 22.75 61.75 19.8352 61.75 16.25C61.75 12.6648 58.8352 9.75 55.25 9.75C51.6648 9.75 48.75 12.6648 48.75 16.25C48.75 19.8352 51.6648 22.75 55.25 22.75ZM58.5 26H52C50.2125 26 48.5977 26.7211 47.4195 27.8891C51.5125 30.1336 54.4172 34.1859 55.0469 39H61.75C63.5477 39 65 37.5477 65 35.75V32.5C65 28.9148 62.0852 26 58.5 26ZM32.5 26C38.7867 26 43.875 20.9117 43.875 14.625C43.875 8.33828 38.7867 3.25 32.5 3.25C26.2133 3.25 21.125 8.33828 21.125 14.625C21.125 20.9117 26.2133 26 32.5 26ZM40.3 29.25H39.457C37.3445 30.2656 34.9984 30.875 32.5 30.875C30.0016 30.875 27.6656 30.2656 25.543 29.25H24.7C18.2406 29.25 13 34.4906 13 40.95V43.875C13 46.5664 15.1836 48.75 17.875 48.75H47.125C49.8164 48.75 52 46.5664 52 43.875V40.95C52 34.4906 46.7594 29.25 40.3 29.25ZM17.5805 27.8891C16.4023 26.7211 14.7875 26 13 26H6.5C2.91484 26 0 28.9148 0 32.5V35.75C0 37.5477 1.45234 39 3.25 39H9.94297C10.5828 34.1859 13.4875 30.1336 17.5805 27.8891Z"
            fill="white"
          />
        </svg>
        <div className="flex flex-col gap-1">
          <p>Пользователи</p>
          <p className="text-2xl font-bold">{stats?.usersCount}</p>
        </div>
        <div className="absolute right-4 top-4 w-[140px]">
          <Select value={users} setValue={setUsers} values={usersSelectors} />
        </div>
      </div>
      <div className="relative flex items-center px-8 py-6 rounded-lg shadow bg-saturateBlue/10 gap-6">
        <svg
          width="52"
          height="52"
          viewBox="0 0 52 52"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12.2978 9.2235C20.8084 2.249 33.3859 2.73434 41.3311 10.6795C49.7919 19.1403 49.7919 32.8597 41.3311 41.3205C32.8703 49.7813 19.1509 49.7813 10.6901 41.3205C8.09401 38.7274 6.19955 35.517 5.18459 31.9908C4.16964 28.4646 4.0675 24.7383 4.88776 21.1618L5.0546 20.4837L9.24493 21.5887C8.20611 25.5369 8.59427 29.7251 10.341 33.4152C12.0877 37.1052 15.0809 40.0603 18.7931 41.7596C22.5052 43.4589 26.6981 43.7934 30.6326 42.7041C34.5672 41.6148 37.9911 39.1716 40.3007 35.8051C42.6103 32.4386 43.6575 28.3649 43.2578 24.3019C42.858 20.2389 41.0369 16.4474 38.1155 13.5956C35.194 10.7438 31.3597 9.01478 27.2882 8.71318C23.2168 8.41158 19.1695 9.5568 15.8598 11.947L15.3831 12.3067L17.5866 14.5102L7.6286 16.8068L9.92526 6.84884L12.2978 9.2235ZM28.1773 13V17.3333H33.5939V21.6667H21.6773C21.4065 21.6662 21.1455 21.7671 20.9454 21.9494C20.7453 22.1318 20.6208 22.3825 20.5964 22.6521C20.5719 22.9217 20.6493 23.1907 20.8132 23.4061C20.9772 23.6216 21.2159 23.7678 21.4823 23.816L21.6773 23.8333H30.3439C31.7805 23.8333 33.1583 24.404 34.1741 25.4198C35.1899 26.4357 35.7606 27.8134 35.7606 29.25C35.7606 30.6866 35.1899 32.0643 34.1741 33.0802C33.1583 34.096 31.7805 34.6667 30.3439 34.6667H28.1773V39H23.8439V34.6667H18.4273V30.3333H30.3439C30.6146 30.3338 30.8757 30.233 31.0758 30.0506C31.2758 29.8682 31.4004 29.6175 31.4248 29.3479C31.4493 29.0783 31.3719 28.8093 31.208 28.5939C31.044 28.3785 30.8053 28.2322 30.5389 28.184L30.3439 28.1667H21.6773C20.2407 28.1667 18.8629 27.596 17.8471 26.5802C16.8313 25.5643 16.2606 24.1866 16.2606 22.75C16.2606 21.3134 16.8313 19.9357 17.8471 18.9198C18.8629 17.904 20.2407 17.3333 21.6773 17.3333H23.8439V13H28.1773Z"
            fill="white"
          />
        </svg>
        <div className="flex flex-col gap-1">
          <p>Оборот</p>
          <p className="text-2xl font-bold">
            {formatNumberWithSpaces(stats?.financialRotation)} R
          </p>
        </div>
        <div className="absolute right-4 top-4 w-[140px]">
          <Select
            value={financialRotation}
            setValue={setFinancialRotation}
            values={financialSelectors}
          />
        </div>
      </div>
      <div className="relative flex items-center px-8 py-6 rounded-lg shadow bg-saturateBlue/10 gap-6">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="52"
          height="52"
          viewBox="0 0 52 52"
          fill="none"
        >
          <g clip-path="url(#clip0_2452_678)">
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M24.9154 6.5C27.0453 6.50016 29.1166 7.19746 30.813 8.4854C32.5094 9.77334 33.7376 11.5811 34.31 13.6327L34.4227 14.0768L38.4744 13.065C38.7705 12.9913 39.0789 12.981 39.3793 13.0347C39.6797 13.0885 39.9654 13.2051 40.2176 13.3769C40.4698 13.5487 40.6829 13.7719 40.8428 14.0318C41.0028 14.2917 41.1061 14.5824 41.1459 14.885L41.1654 15.1667V19.0883C42.3869 20.2595 43.3879 21.6407 44.1207 23.166L44.4197 23.8333H45.4987C46.0294 23.8334 46.5416 24.0282 46.9382 24.3809C47.3347 24.7335 47.5881 25.2195 47.6502 25.7465L47.6654 26V32.5C47.6654 32.8566 47.5774 33.2077 47.4093 33.5222C47.2411 33.8367 46.9979 34.1047 46.7012 34.3027L46.4672 34.437L43.9365 35.7045C42.9005 37.7089 41.3998 39.4361 39.5599 40.742L38.9987 41.119V43.3333C38.9986 43.864 38.8038 44.3762 38.4511 44.7728C38.0985 45.1694 37.6126 45.4227 37.0855 45.4848L36.832 45.5H30.332C29.8013 45.4999 29.2891 45.3051 28.8926 44.9524C28.496 44.5998 28.2426 44.1139 28.1805 43.5868L28.1654 43.3333H25.9987C25.9986 43.864 25.8038 44.3762 25.4511 44.7728C25.0985 45.1694 24.6126 45.4227 24.0855 45.4848L23.832 45.5H17.332C16.8013 45.4999 16.2891 45.3051 15.8926 44.9524C15.496 44.5998 15.2426 44.1139 15.1805 43.5868L15.1654 43.3333V41.119C13.6001 40.1183 12.2481 38.8182 11.1869 37.2933C10.1257 35.7684 9.37626 34.0489 8.9817 32.2335C7.70407 31.8533 6.57413 31.0896 5.74481 30.046C4.9155 29.0024 4.42686 27.7292 4.34503 26.3987L4.33203 26V24.9167C4.33264 24.3644 4.5441 23.8333 4.9232 23.4317C5.3023 23.0301 5.82043 22.7885 6.37172 22.7561C6.92301 22.7238 7.46585 22.9031 7.88934 23.2576C8.31282 23.612 8.58497 24.1148 8.6502 24.6632L8.66536 24.9167V26C8.66536 26.3207 8.7347 26.6262 8.86037 26.8992C9.19107 24.9485 9.92881 23.0894 11.0256 21.4428C12.1223 19.7961 13.5535 18.3989 15.226 17.342C15.0723 15.978 15.2083 14.597 15.6251 13.2892C16.0419 11.9815 16.7302 10.7764 17.6448 9.753C18.5594 8.72956 19.6798 7.91076 20.9327 7.35019C22.1856 6.78962 23.5428 6.4999 24.9154 6.5ZM34.6654 23.8333C34.0907 23.8333 33.5396 24.0616 33.1333 24.4679C32.727 24.8743 32.4987 25.4254 32.4987 26C32.4987 26.5746 32.727 27.1257 33.1333 27.5321C33.5396 27.9384 34.0907 28.1667 34.6654 28.1667C35.24 28.1667 35.7911 27.9384 36.1974 27.5321C36.6038 27.1257 36.832 26.5746 36.832 26C36.832 25.4254 36.6038 24.8743 36.1974 24.4679C35.7911 24.0616 35.24 23.8333 34.6654 23.8333ZM24.9154 10.8333C23.603 10.8333 22.3353 11.3098 21.3477 12.1742C20.3602 13.0385 19.7201 14.232 19.5464 15.5328C20.5963 15.289 21.6708 15.1661 22.7487 15.1667H30.0655L30.2172 15.1298C29.9603 13.9142 29.2932 12.8239 28.328 12.0417C27.3627 11.2594 26.1578 10.8328 24.9154 10.8333Z"
              fill="white"
            />
          </g>
          <defs>
            <clipPath id="clip0_2452_678">
              <rect width="52" height="52" fill="white" />
            </clipPath>
          </defs>
        </svg>
        <div className="flex flex-col gap-1">
          <p>Комиссия</p>
          <p className="text-2xl font-bold">
            {formatNumberWithSpaces(stats?.lobbyComissions)} R
          </p>
        </div>
        <div className="absolute right-4 top-4 w-[140px]">
          <Select
            value={comission}
            setValue={setComission}
            values={comissionsSelectors}
          />
        </div>
      </div>
      <div className="relative flex items-center px-8 py-6 rounded-lg shadow bg-saturateBlue/10 gap-6">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="52"
          height="52"
          viewBox="0 0 52 52"
          fill="none"
        >
          <path
            d="M38.9578 16.25C38.999 16.7656 39.0206 17.0235 39.1528 17.1621C39.2871 17.3008 39.5515 17.3355 40.0823 17.4005C42.2707 17.6745 44.2723 18.7726 45.6794 20.471C47.0864 22.1694 47.793 24.3404 47.6551 26.5416C47.5173 28.7428 46.5454 30.8086 44.9375 32.3183C43.3296 33.8279 41.2066 34.6677 39.0011 34.6666H37.9178C37.4065 34.6666 37.1508 34.6666 36.9926 34.5085C36.8345 34.3503 36.8345 34.0946 36.8345 33.5833V30.3333C36.8345 26.247 36.8345 24.206 35.5648 22.9363C34.2951 21.6666 32.2541 21.6666 28.1678 21.6666H23.8345C19.7481 21.6666 17.7071 21.6666 16.4375 22.9363C15.1678 24.206 15.1678 26.247 15.1678 30.3333V33.5833C15.1678 34.0946 15.1678 34.3503 15.0096 34.5085C14.8515 34.6666 14.5958 34.6666 14.0845 34.6666H13.0011C10.7925 34.6722 8.66515 33.8344 7.05348 32.3243C5.44181 30.8142 4.46746 28.7458 4.32945 26.5415C4.19144 24.3373 4.90018 22.1635 6.31092 20.4642C7.72165 18.7648 9.72792 17.6682 11.92 17.3983C12.4508 17.3333 12.7151 17.3008 12.8495 17.1621C12.9816 17.0235 13.0033 16.7656 13.0445 16.2521C13.2195 14.1405 13.9083 12.1036 15.0508 10.3191C16.1932 8.53457 17.7547 7.05645 19.5992 6.01352C21.4436 4.97059 23.5151 4.39448 25.6332 4.33538C27.7513 4.27628 29.8517 4.73599 31.7515 5.67445C33.7623 6.66629 35.4825 8.16136 36.7448 10.0144C38.0072 11.8675 38.7709 14.0156 38.9578 16.25Z"
            fill="white"
          />
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M18.6017 25.103C17.332 26.3727 17.332 28.4137 17.332 32.5V36.8334C17.332 40.9197 17.332 42.9607 18.6017 44.2304C19.8714 45.5 21.9124 45.5 25.9987 45.5C30.085 45.5 32.126 45.5 33.3957 44.2304C34.6654 42.9607 34.6654 40.9197 34.6654 36.8334V32.5C34.6654 28.4137 34.6654 26.3727 33.3957 25.103C32.126 23.8334 30.085 23.8334 25.9987 23.8334C21.9124 23.8334 19.8714 23.8334 18.6017 25.103ZM24.9154 32.5C24.3407 32.5 23.7896 32.7283 23.3833 33.1346C22.977 33.541 22.7487 34.0921 22.7487 34.6667C22.7487 35.2413 22.977 35.7924 23.3833 36.1988C23.7896 36.6051 24.3407 36.8334 24.9154 36.8334H27.082C27.6567 36.8334 28.2078 36.6051 28.6141 36.1988C29.0204 35.7924 29.2487 35.2413 29.2487 34.6667C29.2487 34.0921 29.0204 33.541 28.6141 33.1346C28.2078 32.7283 27.6567 32.5 27.082 32.5H24.9154Z"
            fill="white"
          />
        </svg>
        <div className="flex flex-col gap-1">
          <p>Сервера</p>
          <p className="text-2xl font-bold">{stats?.serversCount}</p>
        </div>
        <div className="absolute right-4 top-4 w-[140px]">
          <Select
            value={servers}
            setValue={setServers}
            values={serversSelectors}
          />
        </div>
      </div>
      <div className="relative flex items-center px-8 py-6 rounded-lg shadow bg-saturateBlue/10 gap-6">
        <svg
          width="52"
          height="52"
          viewBox="0 0 52 52"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g clip-path="url(#clip0_2464_589)">
            <path
              d="M36.8347 8.66666C39.2311 8.66666 41.0706 10.4932 42.4334 12.4583L42.8949 13.1538L43.3174 13.8472C43.4517 14.0725 43.5796 14.2978 43.7031 14.5145C45.4082 17.563 46.8924 21.5432 47.8739 25.4757C48.8489 29.3778 49.3884 33.4533 49.0439 36.6578C48.6972 39.8753 47.0397 43.3333 43.3347 43.3333C40.0111 43.3333 37.3916 41.5567 35.2639 39.8212L32.8589 37.804C30.8591 36.166 28.6707 34.6667 26.0014 34.6667C23.3321 34.6667 21.1416 36.166 19.1461 37.804L16.7411 39.819C14.6091 41.5567 11.9896 43.3333 8.66807 43.3333C4.96091 43.3333 3.30341 39.8753 2.95891 36.6578C2.61657 33.4512 3.15391 29.3778 4.12891 25.4757C5.11041 21.5432 6.59457 17.563 8.29974 14.5145L8.68541 13.845L9.10791 13.1538L9.56941 12.4583C10.9322 10.4932 12.7717 8.66666 15.1681 8.66666C16.2731 8.66666 17.3716 8.93532 18.4506 9.25166L19.7354 9.64599C19.9477 9.71099 20.1579 9.77382 20.3681 9.83232C22.2422 10.3697 24.1597 10.8333 26.0014 10.8333C27.8431 10.8333 29.7606 10.3697 31.6347 9.83232L33.5522 9.25382C34.6312 8.93532 35.7297 8.66666 36.8347 8.66666ZM18.4181 17.3333C16.9815 17.3333 15.6037 17.904 14.5879 18.9198C13.5721 19.9357 13.0014 21.3134 13.0014 22.75C13.0014 24.1866 13.5721 25.5643 14.5879 26.5802C15.6037 27.596 16.9815 28.1667 18.4181 28.1667C19.8547 28.1667 21.2324 27.596 22.2482 26.5802C23.2641 25.5643 23.8347 24.1866 23.8347 22.75C23.8347 21.3134 23.2641 19.9357 22.2482 18.9198C21.2324 17.904 19.8547 17.3333 18.4181 17.3333ZM33.5847 17.3333C33.0101 17.3333 32.459 17.5616 32.0527 17.9679C31.6463 18.3743 31.4181 18.9254 31.4181 19.5V20.5833H30.3347C29.7601 20.5833 29.209 20.8116 28.8027 21.2179C28.3963 21.6243 28.1681 22.1754 28.1681 22.75C28.1681 23.3246 28.3963 23.8757 28.8027 24.2821C29.209 24.6884 29.7601 24.9167 30.3347 24.9167H31.4181V26C31.4181 26.5746 31.6463 27.1257 32.0527 27.5321C32.459 27.9384 33.0101 28.1667 33.5847 28.1667C34.1594 28.1667 34.7105 27.9384 35.1168 27.5321C35.5231 27.1257 35.7514 26.5746 35.7514 26V24.9167H36.8347C37.4094 24.9167 37.9605 24.6884 38.3668 24.2821C38.7731 23.8757 39.0014 23.3246 39.0014 22.75C39.0014 22.1754 38.7731 21.6243 38.3668 21.2179C37.9605 20.8116 37.4094 20.5833 36.8347 20.5833H35.7514V19.5C35.7514 18.9254 35.5231 18.3743 35.1168 17.9679C34.7105 17.5616 34.1594 17.3333 33.5847 17.3333ZM18.4181 21.6667C18.7054 21.6667 18.9809 21.7808 19.1841 21.984C19.3873 22.1871 19.5014 22.4627 19.5014 22.75C19.5014 23.0373 19.3873 23.3129 19.1841 23.516C18.9809 23.7192 18.7054 23.8333 18.4181 23.8333C18.1308 23.8333 17.8552 23.7192 17.652 23.516C17.4489 23.3129 17.3347 23.0373 17.3347 22.75C17.3347 22.4627 17.4489 22.1871 17.652 21.984C17.8552 21.7808 18.1308 21.6667 18.4181 21.6667Z"
              fill="white"
            />
          </g>
          <defs>
            <clipPath id="clip0_2464_589">
              <rect width="52" height="52" fill="white" />
            </clipPath>
          </defs>
        </svg>
        <div className="flex flex-col gap-1">
          <p>Матчи</p>
          <p className="text-2xl font-bold">{stats?.matchesCount}</p>
        </div>
        <div className="absolute right-4 top-4 w-[140px]">
          <Select
            value={matches}
            setValue={setMatches}
            values={matchesSelectors}
          />
        </div>
      </div>
    </>
  );
};
